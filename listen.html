<script>
  const SHEET_ID = "1YhKiPh70p96zndU2cvtgEhvClq2a3n-MWy0QGpWS3Pw";
  const drawer = document.getElementById('drawer');
  const alphaBar = document.getElementById('alphaBar');

  // Build alphabet bar
  "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(letter => {
    const btn = document.createElement('button');
    btn.textContent = letter;
    btn.dataset.letter = letter;
    btn.addEventListener('click', () => jumpToLetter(letter));
    alphaBar.appendChild(btn);
  });

  // Fetch episodes using Google Visualization Query
  async function fetchEpisodes() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Podcast&range=A:C&tq=select%20A,B,C`;
    const res = await fetch(url);
    const text = await res.text();

    // Extract JSON from Google’s wrapper
    const jsonText = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s)[1];
    const data = JSON.parse(jsonText);

    if (!data.table || !data.table.rows) return [];

    return data.table.rows.map((row, i) => ({
      title: row.c[0]?.v || `Untitled ${i + 1}`,
      number: row.c[1]?.v || `${i + 1}`,
      spotify: row.c[2]?.v || "",
      gif: `/assets/ep${i + 1}.gif`
    }));
  }

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function renderEpisodes(episodes) {
    drawer.innerHTML = "";
    episodes.forEach((ep, idx) => {
      const tape = document.createElement('div');
      tape.className = 'tape';
      tape.dataset.index = idx;
      tape.dataset.title = ep.title;
      tape.dataset.gif = ep.gif;
      tape.dataset.spotify = ep.spotify;
      tape.dataset.letter = ep.title.trim().charAt(0).toUpperCase();

      tape.innerHTML = `
        <div class="card">
          <img class="8track" src="assets/8track.png" alt="8track with label for ${escapeHtml(ep.title)}">
          <div class="label">
            <div class="title">${escapeHtml(ep.title)}</div>
            <div class="meta">Episode ${escapeHtml(ep.number)}</div>
          </div>
        </div>
      `;
      tape.addEventListener('click', () => playThenEmbed(tape));
      drawer.appendChild(tape);
    });
    observeFocus();
  }

  function jumpToLetter(letter) {
    [...alphaBar.children].forEach(b => b.classList.toggle('active', b.dataset.letter === letter));
    const first = [...drawer.children].find(n => n.dataset.letter === letter);
    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Focus tracking
  let currentFocused = null;
  function observeFocus() {
    const options = { root: null, rootMargin: '-34vh 0 -66vh 0', threshold: 0.5 };
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) setFocus(parseInt(entry.target.dataset.index, 10));
      });
    }, options);
    [...drawer.children].forEach(n => observer.observe(n));
  }

  function setFocus(index) {
    if (currentFocused === index) return;
    currentFocused = index;
    const nodes = [...drawer.children];
    nodes.forEach((n, i) => {
      n.classList.remove('focused', 'near');
      if (i === index) n.classList.add('focused');
      if (i === index - 1) n.classList.add('near');
      if (index < 3 && i < index && i >= index - 2) n.classList.add('near');
    });
  }

  // Gif then Spotify embed
  function playThenEmbed(tape) {
    if (tape.dataset.playing === '1') return;
    tape.dataset.playing = '1';

    const gif = tape.dataset.gif;
    const spotify = tape.dataset.spotify;
    const card = tape.querySelector('.card');

    const replace = document.createElement('div');
    replace.className = 'media-replace';
    replace.innerHTML = `<img src="${gif}" alt="${escapeHtml(tape.dataset.title)} preview">`;

    const close = document.createElement('button');
    close.textContent = '✕';
    close.style.cssText = 'position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.4);border:0;color:#fff;padding:6px;border-radius:6px;cursor:pointer;';
    replace.appendChild(close);
    card.appendChild(replace);

    const cleanup = () => {
      replace.remove();
      const wrap = document.createElement('div');
      wrap.className = 'player-wrap';
      const iframe = document.createElement('iframe');
      iframe.src = spotify;
      iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
      wrap.appendChild(iframe);
      card.appendChild(wrap);

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Close';
      removeBtn.style.cssText = 'margin-top:8px;padding:8px 12px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);color:#fff;cursor:pointer;';
      removeBtn.addEventListener('click', () => { wrap.remove(); tape.dataset.playing = '0'; });
      card.appendChild(removeBtn);
    };

    const timer = setTimeout(cleanup, 8000);
    close.addEventListener('click', () => { clearTimeout(timer); cleanup(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { clearTimeout(timer); cleanup(); } }, { once: true });
  }

  // Keyboard nav
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowDown') { e.preventDefault(); navigate(1); }
    if (e.key === 'ArrowUp') { e.preventDefault(); navigate(-1); }
  });

  function navigate(dir) {
    const nodes = [...drawer.children];
    const target = Math.max(0, Math.min(nodes.length - 1, (currentFocused ?? 0) + dir));
    nodes[target].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Init
  fetchEpisodes().then(renderEpisodes);
  setTimeout(() => setFocus(0), 120);
</script>
