let targetScroll = 0;
let currentScroll = 0;
const container = document.getElementById('cassette-container');

container.addEventListener('scroll', () => {
  targetScroll = container.scrollTop;
});

// Animation loop
function smoothScroll() {
  currentScroll += (targetScroll - currentScroll) * 0.1; // easing factor
  updatePulledOutSmooth(currentScroll);
  requestAnimationFrame(smoothScroll);
}
requestAnimationFrame(smoothScroll);

function updatePulledOutSmooth(scrollTop) {
  const cassettes = document.querySelectorAll('.cassette');
  const containerHeight = container.offsetHeight;

  let pulledIndex = 0;

  cassettes.forEach((c, index) => {
    const baseOffset = index * -220;
    const offset = baseOffset + scrollTop * 0.05;
    c.style.transform = `translateY(${offset}px) scale(1)`;
    c.classList.remove('pulled-out');
    c.style.zIndex = index;
  });

  for (let i = 0; i < cassettes.length; i++) {
    const topOffset = cassettes[i].offsetTop - scrollTop;
    if (topOffset + cassettes[i].offsetHeight / 2 < containerHeight / 2) {
      pulledIndex = i;
    }
  }

  if (scrollTop + containerHeight >= container.scrollHeight - 10) {
    pulledIndex = cassettes.length - 1;
  }

  const pulled = cassettes[pulledIndex];
  pulled.classList.add('pulled-out');
  const pulledOffset = pulledIndex * -220 + scrollTop * 0.05 - 70;
  pulled.style.transform = `translateY(${pulledOffset}px) scale(1.08)`;
  pulled.style.zIndex = 10;

  // Logo fade
  const logo = document.getElementById('site-logo');
  const maxFadeScroll = 150;
  logo.style.opacity = Math.max(0, 1 - scrollTop / maxFadeScroll);
}
