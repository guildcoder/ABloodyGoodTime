<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listen — 8‑Track Drawer</title>
  <style>
    :root{
      --bg:#050507;
      --panel:#0d0d10;
      --accent:#d94f4f;
      --width-mobile:360px; /* width of center column where tapes live */
      --width-desktop:520px;
    }

    html,body{height:100%;background:var(--bg);color:#eee;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .container{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 12px;}

    /* Top navigation / alphabet lookup */
    .alpha-bar{position:sticky;top:8px;z-index:40;background:linear-gradient(180deg, rgba(5,5,6,0.9), rgba(5,5,6,0.6));backdrop-filter:blur(6px);padding:8px;border-radius:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;width:100%;max-width:980px;margin-bottom:18px}
    .alpha-bar button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:6px;color:#ddd;cursor:pointer;font-size:13px}
    .alpha-bar button.active{border-color:var(--accent);color:var(--accent)}

    /* center column that holds the "drawer" */
    .stage{width:100%;max-width:calc(var(--width-desktop));display:flex;justify-content:center}
    .drawer{width:100%;max-width:var(--width-mobile);position:relative;padding:36px 0 120px;}

    /* Each tape wrapper. We'll overlap them via negative margins and z-index stacking. */
    .tape{width:100%;height:140px;margin: -60px 0 0;display:block;position:relative;cursor:pointer;transition:transform 350ms cubic-bezier(.2,.9,.2,1),opacity 250ms,filter 250ms;}
    .tape:first-child{margin-top:0}

    /* size of image -- we place title box absolutely over the label portion */
    .tape .card{width:100%;height:100%;position:relative;display:block}
    .tape img.8track{width:100%;height:100%;object-fit:contain;display:block;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.8);}

    /* label overlay (title on the cassette label) */
    .label{position:absolute;left:12%;top:36%;transform:translateY(-50%);width:76%;padding-left:8px;padding-right:8px;pointer-events:none}
    .title{font-weight:700;font-size:15px;line-height:1.05;color:#111;background:rgba(255,255,255,0.94);padding:6px 8px;border-radius:4px;display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:12px;color:rgba(17,17,17,0.7);margin-top:4px}

    /* focused state — pulled out and slightly larger and lifted */
    .tape.focused{transform:translateY(-22px) scale(1.03);filter:brightness(1.02);z-index:50}
    .tape.near{transform:translateY(-10px) scale(1.01);z-index:40}

    /* the first visible should look slightly more pulled when page loads */
    .tape:first-of-type{z-index:60}

    /* gif overlay styling */
    .media-replace{position:absolute;inset:0;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#000}
    .media-replace img{width:100%;height:100%;object-fit:cover}

    /* spotify embed area */
    .player-wrap{margin-top:14px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .player-wrap iframe{width:100%;height:166px;border-radius:6px;border:0}

    /* responsiveness */
    @media (min-width:1000px){
      .drawer{max-width:var(--width-desktop)}
      .tape{height:180px}
      .label{top:42%;left:12%;width:76%}
      .title{font-size:16px}
    }

    /* subtle alphabet helper at bottom to indicate sticky focus position */
    .focus-marker{position:fixed;left:50%;transform:translateX(-50%);top:34vh;height:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="alpha-bar" id="alphaBar" aria-label="Alphabet lookup" role="toolbar"></div>

    <div class="stage">
      <div class="drawer" id="drawer">
        <!-- tapes will be injected by JS; structure for each tape:
             <div class="tape" data-title="..." data-gif="/assets/ep1.gif" data-spotify="https://open.spotify.com/embed/episode/XXX">
               <div class="card">
                 <img class="8track" src="/assets/8track.png">
                 <div class="label"><div class="title">Episode Title</div><div class="meta">Ep # — Short meta</div></div>
               </div>
             </div>
        -->
      </div>
    </div>

    <div class="focus-marker" aria-hidden="true"></div>
  </div>

  <script>
    /*************************************************************************
     * Placeholder episode data. Replace this by fetching your Google Sheet
     * and building an array of objects like this: {title, number, gif, spotify}
     *************************************************************************/
    const episodes = [
      {title:'Intro — The Drawer', number:'001', gif:'/assets/ep1.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE1'},
      {title:'Night Shift Tales', number:'002', gif:'/assets/ep2.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE2'},
      {title:'Static & Shadows', number:'003', gif:'/assets/ep3.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE3'},
      {title:'Undercroft', number:'004', gif:'/assets/ep4.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE4'},
      {title:'The Archivist', number:'005', gif:'/assets/ep5.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE5'},
      {title:'Late Night Rewind', number:'006', gif:'/assets/ep6.gif', spotify:'https://open.spotify.com/embed/episode/REPLACE6'}
    ];

    const drawer = document.getElementById('drawer');
    const alphaBar = document.getElementById('alphaBar');

    // Build alphabet lookup buttons
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    alphabet.forEach(letter=>{
      const btn = document.createElement('button');
      btn.textContent = letter;
      btn.dataset.letter = letter;
      btn.addEventListener('click', ()=> jumpToLetter(letter));
      alphaBar.appendChild(btn);
    });

    // Render tapes
    episodes.forEach((ep, idx)=>{
      const tape = document.createElement('div');
      tape.className = 'tape';
      tape.dataset.index = idx;
      tape.dataset.title = ep.title;
      tape.dataset.gif = ep.gif;
      tape.dataset.spotify = ep.spotify;
      tape.dataset.letter = ep.title.trim().charAt(0).toUpperCase();

      tape.innerHTML = `
        <div class="card">
          <img class="8track" src="/assets/8track.png" alt="8track cassette showing label for ${escapeHtml(ep.title)}">
          <div class="label">
            <div class="title">${escapeHtml(ep.title)}</div>
            <div class="meta">Episode ${escapeHtml(ep.number)}</div>
          </div>
        </div>
      `;

      // click handler to play gif then show embed
      tape.addEventListener('click', ()=> playThenEmbed(tape));

      drawer.appendChild(tape);
    });

    // Utility to escape HTML in template
    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

    // Jump to first tape that starts with letter
    function jumpToLetter(letter){
      // clear active state
      Array.from(alphaBar.children).forEach(b=>b.classList.toggle('active', b.dataset.letter===letter));
      const first = Array.from(drawer.children).find(node=>node.dataset.letter===letter);
      if(first) first.scrollIntoView({behavior:'smooth',block:'center'});
    }

    /*******************************************************************
     * Scrolling focus logic using IntersectionObserver.
     * We'll create an observer that marks which tape is crossing a center
     * focus line (about 34vh from top). Whichever tape crosses becomes
     * .focused. We'll also give .near to the previous one so the visual
     * "pulled drawer" effect cascades for the top three.
     *******************************************************************/
    const options = {
      root:null,
      rootMargin: `-34vh 0 -66vh 0`, // this creates a virtual horizontal band around the focus point
      threshold: 0.5
    };

    let currentFocused = null;
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        const el = entry.target;
        if(entry.isIntersecting){
          setFocus(parseInt(el.dataset.index,10));
        }
      });
    }, options);

    // observe all tapes
    Array.from(drawer.children).forEach(node=>observer.observe(node));

    function setFocus(index){
      if(currentFocused===index) return;
      currentFocused = index;
      const nodes = Array.from(drawer.children);
      nodes.forEach((n,i)=>{
        n.classList.remove('focused','near');
        if(i===index) n.classList.add('focused');
        // mark the previous one as "near" (pulled less)
        if(i===index-1) n.classList.add('near');
        // also mark two above for initial stacked effect (only when index<3 to satisfy first-three special-case)
        if(index < 3 && i < index && i >= index-2) n.classList.add('near');
      });
    }

    // Initialize focus at top
    setTimeout(()=> setFocus(0), 120);

    /*******************************************************************
     * Play GIF for 8 seconds, then replace with Spotify embed player.
     * After the player is shown, user can close the player by pressing
     * esc or clicking close (we'll add a small close control when active)
     *******************************************************************/
    function playThenEmbed(tape){
      // Prevent repeatedly triggering
      if(tape.dataset.playing=== '1') return;
      tape.dataset.playing = '1';

      const gif = tape.dataset.gif;
      const spotify = tape.dataset.spotify;

      // create gif overlay
      const replace = document.createElement('div');
      replace.className = 'media-replace';
      const img = document.createElement('img');
      img.src = gif; img.alt = tape.dataset.title + ' preview';
      replace.appendChild(img);

      // small close button (in case user wants to skip)
      const close = document.createElement('button');
      close.textContent = '✕';
      close.style.cssText = 'position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.4);border:0;color:#fff;padding:6px;border-radius:6px;cursor:pointer;';
      replace.appendChild(close);

      const card = tape.querySelector('.card');
      card.appendChild(replace);

      let finished = false;
      const cleanup = ()=>{
        if(finished) return; finished = true;
        replace.remove();
        // show spotify embed
        const wrap = document.createElement('div'); wrap.className='player-wrap';
        const iframe = document.createElement('iframe');
        iframe.src = spotify; iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
        wrap.appendChild(iframe);
        card.appendChild(wrap);

        // add a close control to remove player
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Close';
        removeBtn.style.cssText = 'margin-top:8px;padding:8px 12px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);color:#fff;cursor:pointer;';
        removeBtn.addEventListener('click', ()=>{
          wrap.remove(); tape.dataset.playing='0';
        });
        card.appendChild(removeBtn);
      };

      close.addEventListener('click', ()=>{ clearTimeout(timer); cleanup(); });

      // 8 second timer (8000ms). If the GIF is shorter, it'll loop but we still move on.
      const timer = setTimeout(()=> cleanup(), 8000);

      // Also allow esc to close
      const keyHandler = (e)=>{ if(e.key==='Escape') { clearTimeout(timer); cleanup(); document.removeEventListener('keydown', keyHandler); }};
      document.addEventListener('keydown', keyHandler);
    }

    /*******************************************************************
     * Small accessibility: keyboard navigation between tapes and letters
     *******************************************************************/
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowDown'){ e.preventDefault(); navigate(1); }
      if(e.key==='ArrowUp'){ e.preventDefault(); navigate(-1); }
    });
    function navigate(dir){
      const nodes = Array.from(drawer.children);
      let target = Math.max(0, Math.min(nodes.length-1, (currentFocused===null?0:currentFocused) + dir));
      nodes[target].scrollIntoView({behavior:'smooth',block:'center'});
    }

    /*******************************************************************
     * Hook for integrating Google Sheet later:
     * - Replace the placeholder `episodes` array by fetching the sheet
     * - Rebuild the drawer DOM after data fetch
     * - Use ep.gif (hosted in /assets or remote) and ep.spotify (embed url)
     *******************************************************************/
  </script>
</body>
</html>
