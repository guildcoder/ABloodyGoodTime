<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Watch — A Bloody Good Time</title>

  <!-- Replace with your styles.css if you want; included key styles inline for the component -->
  <style>
    :root{
      --creepy-accent: #d6a9a9;
      --poster-width: 200px;
      --poster-height: 320px;
      --gap: 18px;
    }
    html,body{height:100%; margin:0; font-family: "Cinzel", "Cinzel Decorative", Georgia, serif; background: #040404; color: #eee; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .site-header{padding:18px 24px; text-align:center}
    .logo{max-width:220px; display:inline-block}

    main{max-width:1300px; margin: 18px auto; padding: 18px;}

    /* Alphabet filter */
    .alpha-filter{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;}
    .alpha-filter button{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--creepy-accent); padding:6px 8px; border-radius:6px; cursor:pointer; font-size:14px; letter-spacing:1px;}
    .alpha-filter button.active{background:rgba(0,0,0,0.6); box-shadow: 0 4px 18px rgba(0,0,0,0.6); border-color:var(--creepy-accent); color:#fff;}

    /* Poster stage */
    .poster-viewport{position:relative; overflow:hidden; padding:20px 0; border-radius:12px;}
    .poster-stage{
      display:flex;
      gap: var(--gap);
      padding: 20px;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      align-items:flex-start;
      transition: transform .5s ease;
    }
    /* hide scrollbar but allow scrolling */
    .poster-stage::-webkit-scrollbar { height:8px; }
    .poster-stage::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }

    .poster-card{
      flex: 0 0 auto;
      width: var(--poster-width);
      height: var(--poster-height);
      background: #111;
      border-radius: 8px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.02);
      background-size: cover;
      background-position: center;
      cursor:pointer;
      position:relative;
      scroll-snap-align: center;
      transition: transform .25s ease, box-shadow .25s ease;
      border: 2px solid rgba(255,255,255,0.03);
    }
    .poster-card:hover{ transform: translateY(-8px) scale(1.03); box-shadow: 0 28px 60px rgba(0,0,0,0.9); }

    /* name + year */
    .poster-meta{
      width: var(--poster-width);
      text-align:center;
      margin-top:8px;
      font-family: "EB Garamond", Georgia, serif;
      font-size:13px;
      color:#d8cfcf;
      letter-spacing:0.6px;
    }
    .poster-title{ font-weight:700; font-size:14px;}
    .poster-year{ font-size:12px; color:#b8a9a9; margin-left:8px; font-weight:400; }

    /* Theater view */
    .theater { display:none; padding:20px; max-width:1100px; margin: 12px auto; }
    .screen {
      background:black;
      height: 480px;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      overflow:hidden;
      position:relative;
      box-shadow: 0 40px 120px rgba(0,0,0,0.9), inset 0 0 120px rgba(0,0,0,0.6);
    }
    .leave-theater{
      margin-top:12px;
      display:inline-block;
      padding:8px 12px;
      border-radius:8px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--creepy-accent);
      cursor:pointer;
    }

    /* animation overlay (GIF) and fade */
    .overlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.6);
      z-index:1200;
      opacity:0;
      pointer-events:none;
      transition:opacity .4s ease;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .walk-gif {
      width:100%;
      max-width:1200px;
      height:100%;
      max-height:100vh;
      background-repeat:no-repeat;
      background-position:center;
      background-size:cover;
      display:block;
    }
    .fade-to-black {
      position:absolute; inset:0; background:black; opacity:0; transition:opacity .7s ease; z-index:1210;
    }
    .fade-to-black.show{ opacity:1; }

    /* small creepy font look (below posters) */
    .creepy-hint{ font-family: "Cormorant Garamond", "Times New Roman", serif; font-size:12px; color:#bfb2b2; text-align:center; margin-top:6px; opacity:0.9; letter-spacing:1px; }

    /* Responsive behavior: on mobile show single poster in center, map vertical scroll to horizontal */
    @media (max-width: 768px){
      :root{ --poster-width: 86vw; --poster-height: 130vw; }
      main{ padding:12px; }
      .poster-stage{ padding: 10px 12px; gap: 12px; }
      /* We'll let the page scroll vertically and map that to poster-stage.scrollLeft */
      /* Make page tall enough for meaningful vertical scroll */
      .scroll-mapper { height: 160vh; } /* adjust if you want more scroll room */
      .poster-viewport{ position:sticky; top:10vh; background:transparent; }
      .poster-meta{ font-size:13px; }
    }

    /* subtle film grain / vignette hook — leave it minimal so your background can do heavy lifting */
    .film-overlay{
      position:absolute; inset:0; pointer-events:none; z-index:50;
      background-image: radial-gradient(ellipse at center, rgba(0,0,0,0.0), rgba(0,0,0,0.65) 70%);
      mix-blend-mode:multiply;
    }

    /* small utility */
    .center{display:flex; align-items:center; justify-content:center;}
    .hidden{display:none;}
    .error{ color:#ffb3b3; text-align:center; margin-top:12px; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html"><img src="assets/logo.png" alt="logo" class="logo"></a>
  </header>

  <main>
    <div class="alpha-filter" id="alphaFilter" aria-label="Alphabet filter">
      <!-- letters generated by JS -->
    </div>

    <div class="poster-viewport" id="posterViewport" aria-live="polite">
      <div class="poster-stage" id="posterStage" role="list">
        <!-- posters injected here -->
      </div>
      <div class="film-overlay"></div>
    </div>

    <!-- For mobile vertical mapping, add an extra tall element -->
    <div class="scroll-mapper" id="scrollMapper" aria-hidden="true"></div>

    <div id="noData" class="error hidden">Could not load movies. Please check sheet sharing settings.</div>

    <section class="theater" id="theater" aria-hidden="true">
      <div class="screen" id="screen">
        <div id="ytplayer" style="width:100%; height:100%;"></div>
      </div>
      <div style="margin-top:10px; text-align:center;">
        <button id="leaveTheater" class="leave-theater">Leave theater</button>
      </div>
    </section>
  </main>

  <!-- Overlay GIF and fade (played when poster clicked) -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="walk-gif" id="walkGif" style="background-image: url('assets/walk_in.gif');"></div>
    <div class="fade-to-black" id="fadeBlack"></div>
  </div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
  (function(){
    const SPREADSHEET_ID = '1qYqjDqwpStWiMooy5yhR2Gjn70bf0muhQomwpPq98iU';
    const SHEET_NAME = 'Movies';
    const GIF_DURATION_MS = 8000; // 8 seconds
    const posterStage = document.getElementById('posterStage');
    const alphaFilter = document.getElementById('alphaFilter');
    const overlay = document.getElementById('overlay');
    const walkGif = document.getElementById('walkGif');
    const fadeBlack = document.getElementById('fadeBlack');
    const theater = document.getElementById('theater');
    const posterViewport = document.getElementById('posterViewport');
    const scrollMapper = document.getElementById('scrollMapper');
    const noData = document.getElementById('noData');
    const leaveTheaterBtn = document.getElementById('leaveTheater');
    const PLAY_FLAG = 'bgt_media_playing';

    let movies = []; // {img, title, year, video}
    let filteredMovies = [];
    let ytPlayer = null;
    let pendingVideoId = null;
    let isMobile = window.matchMedia('(max-width:768px)').matches;

    // Build alphabet filter A-Z + All
    const letters = ['All', ...Array.from({length:26}, (_,i)=>String.fromCharCode(65+i))];
    letters.forEach(l=>{
      const btn = document.createElement('button');
      btn.textContent = l;
      btn.dataset.letter = l;
      if(l === 'All') btn.classList.add('active');
      btn.addEventListener('click', () => {
        document.querySelectorAll('.alpha-filter button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter(l);
      });
      alphaFilter.appendChild(btn);
    });

    // fetch Google sheet via gviz query and parse
    async function fetchMoviesFromSheet(){
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=A:D&tqx=out:json`;
      try{
        const res = await fetch(url);
        const text = await res.text();
        // Google returns something like: /**/google.visualization.Query.setResponse(...);
        const jsonText = text.replace(/^[^\(]*\(/, '').replace(/\);?$/, '');
        const data = JSON.parse(jsonText);
        const table = data.table;
        if(!table || !table.rows || table.rows.length === 0){
          throw new Error('No rows');
        }
        movies = table.rows.map(r => {
          const a = (r.c[0] && r.c[0].v) ? String(r.c[0].v).trim() : '';
          const b = (r.c[1] && r.c[1].v) ? String(r.c[1].v).trim() : '';
          const c = (r.c[2] && r.c[2].v) ? String(r.c[2].v).trim() : '';
          const d = (r.c[3] && r.c[3].v) ? String(r.c[3].v).trim() : '';
          return { img: a, title: b, year: c, video: d };
        }).filter(m => m.img || m.title);
        filteredMovies = movies.slice();
        renderPosters(filteredMovies);
      }catch(err){
        console.error('Failed to load sheet:', err);
        noData.classList.remove('hidden');
      }
    }

    function renderPosters(list){
      posterStage.innerHTML = '';
      list.forEach((m, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'poster-wrap';
        // Poster card
        const card = document.createElement('div');
        card.className = 'poster-card';
        card.style.backgroundImage = m.img ? `url('${escapeUrl(m.img)}')` : "linear-gradient(180deg,#111,#151515)";
        card.setAttribute('role','button');
        card.setAttribute('aria-label', `${m.title} (${m.year || 'unknown year'})`);
        card.dataset.index = idx;
        // click handler
        card.addEventListener('click', () => onPosterClick(idx));

        // meta (title + year)
        const meta = document.createElement('div');
        meta.className = 'poster-meta';
        const tspan = document.createElement('span');
        tspan.className = 'poster-title';
        tspan.textContent = m.title || 'Untitled';
        const yspan = document.createElement('span');
        yspan.className = 'poster-year';
        yspan.textContent = m.year ? `(${m.year})` : '';
        meta.appendChild(tspan);
        meta.appendChild(yspan);

        wrap.appendChild(card);
        wrap.appendChild(meta);
        posterStage.appendChild(wrap);
      });

      // small accessibility hint
      const hint = document.createElement('div');
      hint.className = 'creepy-hint';
      hint.textContent = 'Scroll to browse posters — click a poster to enter the theater';
      posterStage.parentNode.appendChild(hint);

      // ensure we re-wire wheel/touch handlers
      setupHorizontalScroll();
    }

    // sanitize simple URL for css background use (basic)
    function escapeUrl(u){
      return u.replace(/'/g, "\\'");
    }

    function parseYouTubeId(urlOrId){
      if(!urlOrId) return '';
      const s = urlOrId.trim();
      // If plain id-ish (11+ chars and no spaces) return it
      if(/^[A-Za-z0-9_-]{8,}$/.test(s) && !s.includes('youtube') && !s.includes('youtu.be') && !s.includes('v=')) return s;
      // Try youtu.be short URL
      let m = s.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
      if(m) return m[1];
      // Long url with v=
      m = s.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
      if(m) return m[1];
      // embed/ path
      m = s.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
      if(m) return m[1];
      // fallback: last path segment
      m = s.match(/\/([A-Za-z0-9_-]{6,})$/);
      if(m) return m[1];
      return s; // last resort
    }

    // Poster click -> play GIF then show theater & YouTube
    function onPosterClick(index){
      const movie = filteredMovies[index];
      if(!movie) return;
      pendingVideoId = parseYouTubeId(movie.video);
      // Show overlay gif
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      fadeBlack.classList.remove('show');

      // ensure GIF background set (in case user uses a different filename)
      // walkGif.style.backgroundImage = `url('${escapeUrl('assets/walk_in.gif')}')`; // already set; you can change dynamically
      // After (GIF_DURATION_MS - fadeTime) we fade to black and then open theater
      const fadeDelay = Math.max(0, GIF_DURATION_MS - 800); // start fade ~.8s before end
      setTimeout(()=> fadeBlack.classList.add('show'), fadeDelay);

      // After GIF duration, hide overlay, show theater, and init YT player
      setTimeout(()=>{
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        fadeBlack.classList.remove('show');
        // swap views
        showTheaterWithVideo(pendingVideoId);
      }, GIF_DURATION_MS);
    }

    // show theater and create youtube player
    function showTheaterWithVideo(videoId){
      // hide poster area
      document.querySelector('main').scrollIntoView({behavior:'smooth'});
      posterViewport.style.display = 'none';
      theater.style.display = 'block';
      theater.setAttribute('aria-hidden','false');
      // init player
      loadYouTubePlayer(videoId);
    }

    // leave theater
    leaveTheaterBtn.addEventListener('click', () => {
      if (ytPlayer && ytPlayer.stopVideo) try{ ytPlayer.stopVideo(); }catch(e){}
      sessionStorage.removeItem(PLAY_FLAG);
      theater.style.display = 'none';
      posterViewport.style.display = '';
      // If mobile, attempt to scroll to the selected poster
      // No complicated restore — keep it simple
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Horizontal scrolling via wheel on desktop — translate wheel deltaY to scrollLeft
    function setupHorizontalScroll(){
      // remove previous handlers first (defensive)
      posterStage.onwheel = null;
      posterStage.removeEventListener('touchstart', onTouchStart);
      posterStage.removeEventListener('touchmove', onTouchMove);

      if(!isMobile){
        posterStage.addEventListener('wheel', function(e){
          if(Math.abs(e.deltaY) < Math.abs(e.deltaX)){
            // let native x-scrolling occur if user explicitly uses horizontal delta
            return;
          }
          // prevent vertical page scroll
          e.preventDefault();
          posterStage.scrollLeft += e.deltaY + e.deltaX;
        }, {passive:false});
        // Allow swipe on touch devices etc.
        posterStage.addEventListener('touchstart', onTouchStart, {passive:true});
        posterStage.addEventListener('touchmove', onTouchMove, {passive:false});
      } else {
        // On mobile we will map window vertical scroll to posterStage.scrollLeft
        window.removeEventListener('scroll', mobileScrollHandler);
        window.addEventListener('scroll', mobileScrollHandler, {passive:true});
      }
    }

    // minimal touch dragging for desktop-like touchpads
    let touchStartX = 0, touchStartY = 0;
    function onTouchStart(e){
      if(!e.touches || e.touches.length === 0) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
    function onTouchMove(e){
      if(!e.touches || e.touches.length === 0) return;
      const dx = touchStartX - e.touches[0].clientX;
      const dy = touchStartY - e.touches[0].clientY;
      // if mostly horizontal movement, translate to horizontal scroll
      if(Math.abs(dx) > Math.abs(dy)){
        e.preventDefault();
        posterStage.scrollLeft += dx;
      }
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    // Mobile: map window.scrollY to posterStage.scrollLeft
    function mobileScrollHandler(){
      // compute progress through the scroll-mapper element
      const mapperRect = scrollMapper.getBoundingClientRect();
      const vpHeight = window.innerHeight;
      // We'll use the portion of scroll where mapper is in view
      const start = window.scrollY;
      // Simpler: Map page scroll (0 to docHeight - vpHeight) to total scrollLeft range
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      if(docHeight <= 0) return;
      const progress = window.scrollY / docHeight;
      const maxScroll = posterStage.scrollWidth - posterStage.clientWidth;
      posterStage.scrollLeft = Math.round(progress * maxScroll);
    }

    // Apply alphabetical filter (letter = 'All' or 'A'..'Z')
    function applyFilter(letter){
      if(letter === 'All'){
        filteredMovies = movies.slice();
      } else {
        filteredMovies = movies.filter(m => (m.title || '').toUpperCase().startsWith(letter));
      }
      renderPosters(filteredMovies);
      // scroll to start
      posterStage.scrollTo({left:0, behavior:'smooth'});
    }

    // YouTube API integration
    function onYouTubeIframeAPIReady(){
      // kept to satisfy YT callback naming — real player created in loadYouTubePlayer
      window.onYouTubeIframeAPIReady = function(){};
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    function loadYouTubePlayer(videoId){
      if(!videoId){
        console.warn('No video id for link');
        return;
      }
      // Destroy existing player if present
      if(ytPlayer && ytPlayer.destroy) try{ ytPlayer.destroy(); } catch(e){ console.warn(e); }
      // create new player
      ytPlayer = new YT.Player('ytplayer', {
        height: '480',
        width: '100%',
        videoId: videoId,
        playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
        events: {
          'onReady': (e) => {
            try{ e.target.playVideo(); } catch(err){ console.warn('Autoplay blocked or failed', err); }
          },
          'onStateChange': (ev) => {
            if(ev.data === YT.PlayerState.PLAYING) {
              sessionStorage.setItem(PLAY_FLAG, '1');
            } else if(ev.data === YT.PlayerState.PAUSED || ev.data === YT.PlayerState.ENDED) {
              sessionStorage.removeItem(PLAY_FLAG);
            }
          }
        }
      });
    }

    // Utility: if the user resizes, recalc mobile flag
    window.addEventListener('resize', () => {
      isMobile = window.matchMedia('(max-width:768px)').matches;
      setupHorizontalScroll();
    });

    // initial fetch
    fetchMoviesFromSheet();

    // expose some things for debugging
    window._bgt = {
      fetchMoviesFromSheet,
      movies,
      applyFilter,
      parseYouTubeId
    };

  })();
  </script>
</body>
</html>
